version: '3'

services:

  traefik:
    container_name: "traefik"
    hostname: "traefik"
    image: "traefik:v2.6"
    restart: unless-stopped
    command:
      - "--accesslog=false"
      - "--api.dashboard=false"
      - "--experimental.http3=true"

      - "--providers.docker=false"
      - "--providers.docker.watch=true"
      - "--providers.docker.exposedbydefault=false"

      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls.certresolver=myresolver"
      #- "--entrypoints.websecure.http.middlewares=traefik-forward-auth"

      - "--certificatesresolvers.myresolver.acme.email=jimeagle@gmail.com"
      - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
      - "--certificatesresolvers.myresolver.acme.dnschallenge=true"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.delaybeforecheck=10"
    ports:
      - "80:80"
      - "443:443"
    environment:
      CLOUDFLARE_DNS_API_TOKEN: "${CLOUDFLARE_DNS_API_TOKEN}"
      CLOUDFLARE_ZONE_API_TOKEN: "${CLOUDFLARE_ZONE_API_TOKEN}"
    volumes:
      - "${HOME}/Traefik/acme.json:/acme.json"
      - "./traefik/traefik.yaml:/etc/traefik/traefik.yaml"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  radarr:
    image: linuxserver/radarr:latest
    hostname: radarr
    container_name: radarr
    restart: "unless-stopped"
    ports:
      - "7878:7878"
    volumes:
      - ${HOME}/Radarr:/config
      - ${HOME}/NZBGet/Downloads:/downloads
      - ${HOME}/Media/Movies:/movies
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PGID=1000
      - PUID=1000
      - TZ=Europe/London
    labels:
      - "traefik.enable=true"
      - "traefik.port=7878"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.rule=Host(`radarr.jimeagle.com`)"
      - "traefik.http.routers.radarr.middlewares=traefik-forward-auth"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
      - "com.centurylinklabs.watchtower.enable=true"

  sonarr:
    image: linuxserver/sonarr:latest
    hostname: sonarr
    container_name: sonarr
    restart: "unless-stopped"
    ports:
      - "8989:8989"
    environment:
      - PGID=1000
      - PUID=1000
      - TZ=Europe/London
    volumes:
      - ${HOME}/Sonarr:/config
      - ${HOME}/NZBGet/Downloads:/downloads
      - ${HOME}/Media/Television:/tv
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.enable=true"
      - "traefik.port=8989"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.jimeagle.com`)"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "com.centurylinklabs.watchtower.enable=true"

  hydra:
    image: linuxserver/nzbhydra2:latest
    hostname: hydra
    container_name: hydra
    restart: "unless-stopped"
    ports:
      - "5076:5076"
    volumes:
      - ${HOME}/Hydra/Config:/config
      - ${HOME}/Hydra/Downloads:/downloads
    environment:
      - PGID=1000
      - PUID=1000
      - TZ=Europe/London
    labels:
      - "traefik.enable=true"
      - "traefik.port=5076"
      - "traefik.http.routers.hydra.entrypoints=websecure"
      - "traefik.http.routers.hydra.rule=Host(`hydra.jimeagle.com`)"
      - "traefik.http.services.hydra.loadbalancer.server.port=5076"
      - "com.centurylinklabs.watchtower.enable=true"

  nzbget:
    image: linuxserver/nzbget:latest
    hostname: nzbget
    container_name: nzbget
    restart: "unless-stopped"
    ports:
      - "6789:6789"
    environment:
      - PGID=1000
      - PUID=1000
      - TZ=Europe/London
    volumes:
      - ${HOME}/NZBGet/Config:/config
      - ${HOME}/NZBGet/Downloads:/downloads
    labels:
      - "traefik.enable=true"
      - "traefik.port=6789"
      - "traefik.http.routers.nzbget.entrypoints=websecure"
      - "traefik.http.routers.nzbget.rule=Host(`nzbget.jimeagle.com`)"
      - "traefik.http.services.nzbget.loadbalancer.server.port=6789"
      - "com.centurylinklabs.watchtower.enable=true"

  plex:
    image: linuxserver/plex:latest
    hostname: plex
    container_name: plex
    network_mode: "host"
    restart: "unless-stopped"
    environment:
      - PGID=1000
      - PUID=1000
      - TZ=Europe/London
      - VERSION=latest
    volumes:
      - ${HOME}/Plex/Transcoding:/transcode
      - ${HOME}/Plex/Config:/config
      - ${HOME}/Media/Television:/data/tvshows
      - ${HOME}/Media/Movies:/data/movies
      - ${HOME}/Media/YouTube:/data/youtube
      - /dev/dri:/dev/dri # Quicksync
    labels:
      - "traefik.enable=true"
      - "traefik.port=32400"
      - "traefik.http.routers.plex.entrypoints=websecure"
      - "traefik.http.routers.plex.rule=Host(`plex.jimeagle.com`)"
      - "com.centurylinklabs.watchtower.enable=true"

  ddns:
    container_name: ddns
    hostname: ddns
    image: ghcr.io/jleagle/ddns:latest
    restart: "unless-stopped"
    environment:
      - DO_KEY=${DDNS_DO_KEY}
      - CF_KEY=${DDNS_CF_KEY}
      - ONE_TIME=false
      - ON_LOAD=true
    volumes:
      - ${HOME}/DDNS/records.yaml:/root/records.yaml:ro
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  tubesync:
    image: ghcr.io/meeb/tubesync:latest
    hostname: tubesync
    container_name: tubesync
    ports:
      - "4848:4848"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - HTTP_USER=$TUBE_SYNC_USER
      - HTTP_PASS=$TUBE_SYNC_PASS
    volumes:
      - ${HOME}/TubeSync:/config
      - ${HOME}/Media/YouTube:/downloads
      - /dev/dri:/dev/dri # Quicksync
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.port=4848"
      - "traefik.http.routers.tubesync.entrypoints=websecure"
      - "traefik.http.routers.tubesync.rule=Host(`tubesync.jimeagle.com`)"
      - "com.centurylinklabs.watchtower.enable=true"

  hass:
    image: homeassistant/home-assistant:latest
    hostname: hass
    container_name: hass
    restart: "unless-stopped"
    network_mode: host
    privileged: true
    volumes:
      - ${HOME}/Hass:/config
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Europe/London
    labels:
      - "traefik.enable=true"
      - "traefik.port=8123"
      - "traefik.http.routers.hass.entrypoints=websecure"
      - "traefik.http.routers.hass.rule=Host(`hass.jimeagle.com`)"
      - "traefik.http.services.hass.loadbalancer.server.port=8123"
      - "com.centurylinklabs.watchtower.enable=true"

  nodered:
    image: nodered/node-red:latest
    hostname: nodered
    container_name: nodered
    restart: "unless-stopped"
    user: root
    ports:
      - "1880:1880"
    environment:
      - TZ=Europe/London
    volumes:
      - ${HOME}/NodeRed:/data
    labels:
      - "traefik.enable=true"
      - "traefik.port=1880"
      - "traefik.http.routers.nodered.entrypoints=websecure"
      - "traefik.http.routers.nodered.rule=Host(`nodered.jimeagle.com`)"
      - "traefik.http.services.nodered.loadbalancer.server.port=1880"
      - "com.centurylinklabs.watchtower.enable=true"

  phlex:
    image: digitalhigh/phlex:latest
    hostname: phlex
    container_name: phlex
    restart: "unless-stopped"
    ports:
      - "5666:5666"
    volumes:
      - ${HOME}/Phlex:/config
    environment:
      - PGID=1000
      - PUID=1000
      - TZ=Europe/London
    labels:
      - "traefik.enable=true"
      - "traefik.port=5666"
      - "traefik.http.routers.phlex.entrypoints=websecure"
      - "traefik.http.routers.phlex.rule=Host(`phlex.jimeagle.com`)"
      - "com.centurylinklabs.watchtower.enable=true"

  bazarr:
    image: linuxserver/bazarr:latest
    hostname: bazarr
    container_name: bazarr
    ports:
      - "6767:6767"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - UMASK_SET=022 #optional
    volumes:
      - ${HOME}/Bazarr:/config
      - ${HOME}/Media/Movies:/movies
      - ${HOME}/Media/Television:/tv
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.port=6767"
      - "traefik.http.routers.bazarr.entrypoints=websecure"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.jimeagle.com`)"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"
      - "com.centurylinklabs.watchtower.enable=true"

  doubletake:
    container_name: doubletake
    hostname: doubletake
    image: jakowenko/double-take
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ${HOME}/DoubleTake:/.storage
      - ./doubletake/config.yml:/.storage/config.yml
    labels:
      - "traefik.enable=true"
      - "traefik.port=3000"
      - "traefik.http.routers.doubletake.entrypoints=websecure"
      - "traefik.http.routers.doubletake.rule=Host(`doubletake.jimeagle.com`)"
      - "traefik.http.services.doubletake.loadbalancer.server.port=3000"
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    container_name: watchtower
    hostname: watchtower
    image: containrrr/watchtower:latest
    restart: "unless-stopped"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Europe/London
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_NOTIFICATIONS=slack
      - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${WATCHTOWER_WEBHOOK}
      - WATCHTOWER_NOTIFICATIONS_LEVEL=error
      - WATCHTOWER_SCHEDULE=0 0 0 * * *
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_NO_STARTUP_MESSAGE=true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  #  plexmeta:
  #    image: meisnate12/plex-meta-manager:latest
  #    hostname: plexmeta
  #    container_name: plexmeta
  #    network_mode: "host" # For plex
  #    restart: "unless-stopped"
  #    volumes:
  #      - ${HOME}/PlexMeta:/config

  #  frigate:
  #    container_name: frigate
  #    #privileged: true # this may not be necessary for all setups
  #    restart: unless-stopped
  #    image: blakeblackshear/frigate:0.9.4-amd64
  #    shm_size: "64mb" # update for your cameras based on calculation above
  #    #    devices:
  #    #      - /dev/bus/usb:/dev/bus/usb # passes the USB Coral, needs to be modified for other versions
  #    #      - /dev/apex_0:/dev/apex_0 # passes a PCIe Coral, follow driver instructions here https://coral.ai/docs/m2/get-started/#2a-on-linux
  #    #      - /dev/dri/renderD128 # for intel hwaccel, needs to be updated for your hardware
  #    volumes:
  #      - ${HOME}/Frigate/config.yml:/config/config.yml:ro
  #      - ${HOME}/Media/Frigate:/media/frigate
  #      - /etc/localtime:/etc/localtime:ro
  #      - type: tmpfs # Optional: 1GB of memory, reduces SSD/SD Card wear
  #        target: /tmp/cache
  #        tmpfs:
  #          size: 1000000000
  #    ports:
  #      - "1935:1935" # RTMP feeds
  #    environment:
  #      FRIGATE_RTSP_PASSWORD: "password"
  #    labels:
  #      - "traefik.enable=true"
  #      - "traefik.port=5000"
  #      - "traefik.http.routers.frigate.entrypoints=websecure"
  #      - "traefik.http.routers.frigate.rule=Host(`frigate.jimeagle.com`)"
  #      - "traefik.http.services.frigate.loadbalancer.server.port=5000"
  #      - "com.centurylinklabs.watchtower.enable=true"

  traefik-forward-auth:
    hostname: traefik-forward-auth
    container_name: traefik-forward-auth
    image: thomseddon/traefik-forward-auth:2
    ports:
      - "4181:4181"
    environment:
      - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SECRET=${AUTH_SECRET}
      - CONFIG=/config.json
      - WHITELIST=jimeagle@gmail.com
    volumes:
      - ${HOME}/Auth/config.json:/config.json
    labels:
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://traefik-forward-auth:4181"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User"
      - "traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181"

  pihole:
    image: pihole/pihole:latest
    hostname: pihole
    container_name: pihole
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "81:80"
    environment:
      TZ: Europe/London
      ServerIP: 192.168.0.7
      WEBPASSWORD: ${PIHOLE_PASSWORD}
      ADMIN_EMAIL: jimeagle@gmail.com
      PIHOLE_DNS_: 1.1.1.1;8.8.8.8
      VIRTUAL_HOST: pihole.jimeagle.com
    volumes:
      - ${HOME}/PiHole/:/etc/pihole/
    labels:
      - "traefik.enable=true"
      - "traefik.port=80"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.rule=Host(`pihole.jimeagle.com`)"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
      - "com.centurylinklabs.watchtower.enable=true"
