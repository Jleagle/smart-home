version: '3'

services:

  autoheal:
    image: "willfarrell/autoheal:latest"
    container_name: "autoheal"
    hostname: "autoheal"
    restart: "unless-stopped"
    environment:
      - "AUTOHEAL_CONTAINER_LABEL=all"
      - "AUTOHEAL_INTERVAL=10"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"

  bazarr:
    image: "linuxserver/bazarr:latest"
    container_name: "bazarr"
    hostname: "bazarr"
    restart: "unless-stopped"
    ports:
      - "6767:6767"
    environment:
      - "PUID=1000"
      - "PGID=1000"
      - "TZ=Europe/London"
      - "UMASK_SET=022" #optional
    volumes:
      - "${HOME}/Bazarr:/config"
      - "${HOME}/Media/Movies:/movies"
      - "${HOME}/Media/Television:/tv"
    labels:
      - "traefik.enable=true"
      - "traefik.port=6767"
      - "traefik.http.routers.bazarr.entrypoints=websecure"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.jimeagle.com`)"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"

  ddns:
    image: "ghcr.io/jleagle/ddns:latest"
    container_name: "ddns"
    hostname: "ddns"
    restart: "unless-stopped"
    environment:
      - "DO_KEY=${DDNS_DO_KEY}"
      - "CF_KEY=${DDNS_CF_KEY}"
      - "ONE_TIME=false"
      - "ON_LOAD=true"
    volumes:
      - "${HOME}/DDNS/records.yaml:/root/records.yaml:ro"

  doubletake:
    image: "jakowenko/double-take:latest"
    container_name: "doubletake"
    hostname: "doubletake"
    restart: "unless-stopped"
    ports:
      - "3000:3000"
    volumes:
      - "${HOME}/DoubleTake:/.storage"
      - "./doubletake/config.yml:/.storage/config.yml"
    labels:
      - "traefik.enable=true"
      - "traefik.port=3000"
      - "traefik.http.routers.doubletake.entrypoints=websecure"
      - "traefik.http.routers.doubletake.rule=Host(`doubletake.jimeagle.com`)"
      - "traefik.http.routers.doubletake.middlewares=traefik-forward-auth"
      - "traefik.http.services.doubletake.loadbalancer.server.port=3000"

  esphome:
    image: "esphome/esphome:latest"
    container_name: "esphome"
    hostname: "esphome"
    restart: "unless-stopped"
    network_mode: "host"
    volumes:
      - "${HOME}/ESPHome:/config"
      - "/etc/localtime:/etc/localtime:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.port=6052"
      - "traefik.http.routers.esphome.entrypoints=websecure"
      - "traefik.http.routers.esphome.rule=Host(`esphome.jimeagle.com`)"
      - "traefik.http.services.esphome.loadbalancer.server.port=6052"

  flextv:
    image: "digitalhigh/flextv:latest"
    container_name: "flextv"
    hostname: "flextv"
    restart: "unless-stopped"
    ports:
      - "82:80"
    volumes:
      - "${HOME}/FlexTV:/config"
    environment:
      - "PUID=1000"
      - "PGID=1000"
      - "TZ=Europe/London"
    labels:
      - "traefik.enable=true"
      - "traefik.port=80"
      - "traefik.http.routers.flextv.entrypoints=websecure"
      - "traefik.http.routers.flextv.rule=Host(`flextv.jimeagle.com`)"
      - "traefik.http.routers.flextv.middlewares=traefik-forward-auth"
      - "traefik.http.services.flextv.loadbalancer.server.port=80"

  #  frigate:
  #    image: blakeblackshear/frigate:0.9.4-amd64
  #    container_name: frigate
  #    hostname: "frigate"
  #    restart: unless-stopped
  #    #privileged: true # this may not be necessary for all setups
  #    shm_size: "64mb" # update for your cameras based on calculation above
  #    #    devices:
  #    #      - /dev/bus/usb:/dev/bus/usb # passes the USB Coral, needs to be modified for other versions
  #    #      - /dev/apex_0:/dev/apex_0 # passes a PCIe Coral, follow driver instructions here https://coral.ai/docs/m2/get-started/#2a-on-linux
  #    #      - /dev/dri/renderD128 # for intel hwaccel, needs to be updated for your hardware
  #    volumes:
  #      - ${HOME}/Frigate/config.yml:/config/config.yml:ro
  #      - ${HOME}/Media/Frigate:/media/frigate
  #      - /etc/localtime:/etc/localtime:ro
  #      - type: tmpfs # Optional: 1GB of memory, reduces SSD/SD Card wear
  #        target: /tmp/cache
  #        tmpfs:
  #          size: 1000000000
  #    ports:
  #      - "1935:1935" # RTMP feeds
  #    environment:
  #      FRIGATE_RTSP_PASSWORD: "password"
  #    labels:
  #      - "traefik.enable=true"
  #      - "traefik.port=5000"
  #      - "traefik.http.routers.frigate.entrypoints=websecure"
  #      - "traefik.http.routers.frigate.rule=Host(`frigate.jimeagle.com`)"
  #     - "traefik.http.routers.frigate.middlewares=traefik-forward-auth"
  #      - "traefik.http.services.frigate.loadbalancer.server.port=5000"

  grafana:
    image: "grafana/grafana:main"
    container_name: "grafana"
    hostname: "grafana"
    restart: "unless-stopped"
    user: "0"
    environment:
      - "GRAFANA_SMTP_PASS"
    volumes:
      - "${HOME}/Grafana/Data:/var/lib/grafana"
      - "./grafana/grafana.ini:/etc/grafana/grafana.ini:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.port=3001"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.rule=Host(`grafana.jimeagle.com`)"
      - "traefik.http.routers.grafana.middlewares=traefik-forward-auth"
      - "traefik.http.services.grafana.loadbalancer.server.port=3001"

  grafana-image-renderer:
    image: "grafana/grafana-image-renderer:latest"
    container_name: "grafana-image-renderer"
    hostname: "grafana-image-renderer"
    restart: "unless-stopped"

  hass:
    image: "homeassistant/home-assistant:latest"
    container_name: "hass"
    hostname: "hass"
    restart: "unless-stopped"
    network_mode: "host"
    privileged: true
    #devices:
    #  - "/dev/ttyUSB0:/dev/ttyUSB0"
    volumes:
      - "${HOME}/Hass/Config:/config"
      - "${HOME}/Hass/google_assistant_key.json:/config/google_assistant_key.json:ro"
      - "./hass/config.yml:/config/configuration.yaml"
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      - "TZ=Europe/London"

  influx:
    image: "influxdb:2.1"
    container_name: "influx"
    hostname: "influx"
    restart: "unless-stopped"
    volumes:
      - "${HOME}/Influx:/home/influxdb/.influxdbv2/"
      - "./influx/config.yml:/etc/influxdb2/config.yml:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.port=8086"
      - "traefik.http.routers.influx.entrypoints=websecure"
      - "traefik.http.routers.influx.rule=Host(`influx.jimeagle.com`)"
      - "traefik.http.services.influx.loadbalancer.server.port=8086"

  mealie:
    image: "hkotel/mealie:latest"
    container_name: "mealie"
    hostname: "mealie"
    restart: "unless-stopped"
    volumes:
      - "${HOME}/Mealie:/app/data"
    ports:
      - "9925:80"
    environment:
      TZ: "Europe/London"
      DB_ENGINE: "sqlite"
      RECIPE_PUBLIC: 'true'
      RECIPE_SHOW_NUTRITION: 'true'
      RECIPE_SHOW_ASSETS: 'true'
      RECIPE_LANDSCAPE_VIEW: 'true'
      RECIPE_DISABLE_COMMENTS: 'false'
      RECIPE_DISABLE_AMOUNT: 'false'
    labels:
      - "traefik.enable=true"
      - "traefik.port=80"
      - "traefik.http.routers.mealie.entrypoints=websecure"
      - "traefik.http.routers.mealie.rule=Host(`mealie.jimeagle.com`)"
      - "traefik.http.services.mealie.loadbalancer.server.port=80"

  mosquitto:
    image: "eclipse-mosquitto:latest"
    container_name: "mosquitto"
    hostname: "mosquitto"
    restart: "unless-stopped"
    ports:
      - "1883:1883"
    volumes:
      - "${HOME}/Mosquitto/Log/mosquitto.log:/mosquitto/log/mosquitto.log"
      - "${HOME}/Mosquitto/Data:/mosquitto/data"
      - "./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf"

  nodered:
    image: "nodered/node-red:latest"
    container_name: "nodered"
    hostname: "nodered"
    restart: "unless-stopped"
    user: "root"
    ports:
      - "1880:1880"
    environment:
      - "HTTP_USERNAME=${NODE_RED_HTTP_USERNAME}"
      - "HTTP_PASSWORD=${NODE_RED_HTTP_PASSWORD}"
      - "TZ=Europe/London"
    volumes:
      - "${HOME}/NodeRed:/data"
      - "./node-red/settings.js:/data/settings.js:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.port=1880"
      - "traefik.http.routers.nodered.entrypoints=websecure"
      - "traefik.http.routers.nodered.rule=Host(`nodered.jimeagle.com`)"
      - "traefik.http.services.nodered.loadbalancer.server.port=1880"

  nzbget:
    image: "linuxserver/nzbget:latest"
    container_name: "nzbget"
    hostname: "nzbget"
    restart: "unless-stopped"
    ports:
      - "6789:6789"
    environment:
      - "PGID=1000"
      - "PUID=1000"
      - "TZ=Europe/London"
    volumes:
      - "${HOME}/NZBGet/Config:/config"
      - "${HOME}/NZBGet/Downloads:/downloads"
    labels:
      - "traefik.enable=true"
      - "traefik.port=6789"
      - "traefik.http.routers.nzbget.entrypoints=websecure"
      - "traefik.http.routers.nzbget.rule=Host(`nzbget.jimeagle.com`)"
      - "traefik.http.services.nzbget.loadbalancer.server.port=6789"

  overseerr:
    image: "linuxserver/overseerr:latest"
    container_name: "overseerr"
    hostname: "overseerr"
    restart: "unless-stopped"
    ports:
      - "5055:5055"
    environment:
      - "PUID=1000"
      - "PGID=1000"
      - "TZ=Europe/London"
    volumes:
      - "${HOME}/Overseerr:/config"
    labels:
      - "traefik.enable=true"
      - "traefik.port=5055"
      - "traefik.http.routers.overseerr.entrypoints=websecure"
      - "traefik.http.routers.overseerr.rule=Host(`overseerr.jimeagle.com`)"
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"

  pihole:
    image: "pihole/pihole:latest"
    container_name: "pihole"
    hostname: "pihole"
    restart: "unless-stopped"
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "81:80"
    environment:
      TZ: "Europe/London"
      ServerIP: "192.168.0.7"
      WEBPASSWORD: "${PIHOLE_PASSWORD}"
      ADMIN_EMAIL: "jimeagle@gmail.com"
      PIHOLE_DNS_: "1.1.1.1;8.8.8.8"
      VIRTUAL_HOST: "pihole.jimeagle.com"
    volumes:
      - "${HOME}/PiHole/:/etc/pihole/"
    labels:
      - "traefik.enable=true"
      - "traefik.port=80"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.rule=Host(`pihole.jimeagle.com`)"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"

  plex:
    image: "linuxserver/plex:latest"
    container_name: "plex"
    hostname: "plex"
    restart: "unless-stopped"
    network_mode: "host"
    environment:
      - "PGID=1000"
      - "PUID=1000"
      - "TZ=Europe/London"
      - "VERSION=latest"
    volumes:
      - "${HOME}/Plex/Transcoding:/transcode"
      - "${HOME}/Plex/Config:/config"
      - "${HOME}/Media/Television:/data/tvshows"
      - "${HOME}/Media/Movies:/data/movies"
      - "${HOME}/Media/YouTube:/data/youtube"
      - "/dev/dri:/dev/dri" # Quicksync

  #  plexmeta:
  #    image: meisnate12/plex-meta-manager:latest
  #    container_name: plexmeta
  #    hostname: plexmeta
  #    restart: "unless-stopped"
  #    volumes:
  #      - ${HOME}/PlexMeta:/config

  prowlarr:
    image: "linuxserver/prowlarr:develop"
    container_name: "prowlarr"
    hostname: "prowlarr"
    restart: "unless-stopped"
    ports:
      - "9696:9696"
    environment:
      - "PUID=1000"
      - "PGID=1000"
      - "TZ=Europe/London"
    volumes:
      - "${HOME}/Prowlarr:/config"
    labels:
      - "traefik.enable=true"
      - "traefik.port=9696"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.jimeagle.com`)"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  radarr:
    image: "linuxserver/radarr:latest"
    container_name: "radarr"
    hostname: "radarr"
    restart: "unless-stopped"
    ports:
      - "7878:7878"
    volumes:
      - "${HOME}/Radarr:/config"
      - "${HOME}/NZBGet/Downloads:/downloads"
      - "${HOME}/Media/Movies:/movies"
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      - "PGID=1000"
      - "PUID=1000"
      - "TZ=Europe/London"
    labels:
      - "traefik.enable=true"
      - "traefik.port=7878"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.rule=Host(`radarr.jimeagle.com`)"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  sonarr:
    image: "linuxserver/sonarr:latest"
    container_name: "sonarr"
    hostname: "sonarr"
    restart: "unless-stopped"
    ports:
      - "8989:8989"
    environment:
      - "PGID=1000"
      - "PUID=1000"
      - "TZ=Europe/London"
    volumes:
      - "${HOME}/Sonarr:/config"
      - "${HOME}/NZBGet/Downloads:/downloads"
      - "${HOME}/Media/Television:/tv"
      - "/etc/localtime:/etc/localtime:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.port=8989"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.jimeagle.com`)"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  tautulli:
    image: "lscr.io/linuxserver/tautulli:latest"
    container_name: "tautulli"
    hostname: "tautulli"
    restart: "unless-stopped"
    environment:
      - "PUID=1000"
      - "PGID=1000"
      - "TZ=Europe/London"
    volumes:
      - "${HOME}/Tautulli:/config"
    ports:
      - "8181:8181"
    labels:
      - "traefik.enable=true"
      - "traefik.port=8181"
      - "traefik.http.routers.tautulli.entrypoints=websecure"
      - "traefik.http.routers.tautulli.rule=Host(`tautulli.jimeagle.com`)"
      - "traefik.http.services.tautulli.loadbalancer.server.port=8181"

  telegraf:
    image: "telegraf:latest"
    container_name: "telegraf"
    hostname: "telegraf"
    restart: "unless-stopped"
    privileged: true
    user: "telegraf:${DOCKER_USER_ID}"
    environment:
      - "INFLUX_TOKEN=${TELEGRAF_INFLUX_TOKEN}"
      - "MINECRAFT_SERVER=${MINECRAFT_SERVER}"
      - "MINECRAFT_PORT=${MINECRAFT_PORT}"
      - "HOST_MOUNT_PREFIX=/hostfs"
      - "HOST_PROC=/hostfs/proc"
    volumes:
      - "./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro"
      - "/:/hostfs:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"

  traefik:
    image: "traefik:v2.6"
    container_name: "traefik"
    hostname: "traefik"
    restart: "unless-stopped"
    network_mode: "host"
    #    ports:
    #      - "80:80"
    #      - "443:443"
    environment:
      CLOUDFLARE_DNS_API_TOKEN: "${CLOUDFLARE_DNS_API_TOKEN}"
      CLOUDFLARE_ZONE_API_TOKEN: "${CLOUDFLARE_ZONE_API_TOKEN}"
    volumes:
      - "${HOME}/Traefik/acme.json:/acme.json"
      - "./traefik/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "./traefik/providers.yml:/etc/traefik/providers.yml:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  traefik-forward-auth:
    image: "thomseddon/traefik-forward-auth:latest"
    hostname: "traefik-forward-auth"
    container_name: "traefik-forward-auth"
    restart: "unless-stopped"
    ports:
      - "4181:4181"
    environment:
      - "PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}"
      - "PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}"
      - "SECRET=${AUTH_SECRET}"
      - "CONFIG=/config.json"
      - "WHITELIST=jimeagle@gmail.com"
      - "INSECURE_COOKIE=true"
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://localhost:4181"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User"
      - "traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181"

  #  varken:
  #    image: "boerderij/varken:latest"
  #    hostname: "varken"
  #    container_name: "varken"
  #    restart: "unless-stopped"
  #    environment:
  #      - "TZ=Europe/London"
  #      - "VRKN_GLOBAL_SONARR_SERVER_IDS=1"
  #      - "VRKN_GLOBAL_RADARR_SERVER_IDS=1"
  #      - "VRKN_GLOBAL_OMBI_SERVER_IDS=false"
  #      - "VRKN_GLOBAL_MAXMIND_LICENSE_KEY"
  #      - "VRKN_INFLUXDB_URL=influx"
  #      - "VRKN_INFLUXDB_USERNAME"
  #      - "VRKN_INFLUXDB_PASSWORD"
  #      - "VRKN_TAUTULLI_1_URL=tautulli"
  #      - "VRKN_TAUTULLI_1_APIKEY"
  #      - "VRKN_SONARR_1_URL=sonarr"
  #      - "VRKN_SONARR_1_APIKEY"
  #      - "VRKN_RADARR_1_URL=radarr"
  #      - "VRKN_RADARR_1_APIKEY"
  #    volumes:
  #      - "${HOME}/Varken:/config"
